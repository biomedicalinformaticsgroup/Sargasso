#!/usr/bin/env bash

set -o nounset
set -o errexit
set -o xtrace

function listFiles {
    FILES=$@
    
    DELIMITER=","
    OUTPUT=$(ls -1 ${FILES} | tr '\n' "${DELIMITER}")
    echo ${OUTPUT%$DELIMITER}   
}

function bisulfite_se_reads {
    SAMPLE=$1
    SPECIES=$2
    INDEX_DIR=$3
    NUM_THREADS=$4
    READ_FILES=$5
    OUTPUT_DIR=$6
    BISMARK_EXECUTABLE=$7

    ID=${SAMPLE}.${SPECIES}

    # This produce two file in the current folder, ${ID}.sam and ${ID}_SE_repoet.txt
    ${BISMARK_EXECUTABLE} --non_bs_mm --ambig_bam --bowtie2 --output_dir ${OUTPUT_DIR} --basename ${ID} ${INDEX_DIR} ${READ_FILES} > ${OUTPUT_DIR}/${ID}.log.out 2>&1
}

function bisulfite_pe_reads {
    SAMPLE=$1
    SPECIES=$2
    INDEX_DIR=$3
    NUM_THREADS=$4
    READ_1_FILES=$5
    READ_2_FILES=$6
    OUTPUT_DIR=$7
    BISMARK_EXECUTABLE=$8

    ID=${SAMPLE}.${SPECIES}

    # This produce three file in the current folder, ${ID}_pe.bam, ${ID}_pe.ambig.bam and ${ID}_PE_repoet.txt
    ${BISMARK_EXECUTABLE} --non_bs_mm --ambig_bam --bowtie2 --output_dir ${OUTPUT_DIR} --basename ${ID} ${INDEX_DIR} -1 ${READ_1_FILES} -2 ${READ_2_FILES}  > ${OUTPUT_DIR}/${ID}.log.out 2>&1

    mv ${OUTPUT_DIR}/${ID}_pe.bam ${OUTPUT_DIR}/${ID}.bam
    mv ${OUTPUT_DIR}/${ID}_pe.ambig.bam ${OUTPUT_DIR}/${ID}.ambig.bam

    ## we merge the two bam file ${ID}.bam and ${ID}.ambig.bam into one the bam file with our naming convention
    #sambamba merge -l 1 ${OUTPUT_DIR}/${ID}.bam ${OUTPUT_DIR}/${ID}_pe.bam ${OUTPUT_DIR}/${ID}_pe.ambig.bam
    #rm -rf ${OUTPUT_DIR}/${ID}_pe.bam ${OUTPUT_DIR}/${ID}_pe.ambig.bam

}

SPECIES=$1
SAMPLES=$2
BOWTIE2_INDICES=$3
NUM_THREADS=$4
INPUT_DIR=$5
OUTPUT_DIR=$6
READS_TYPE=$7
BISMARK_EXECUTABLE=$8

MULTI_READ_LIMIT=20



for species in ${SPECIES}; do
    for sample in ${SAMPLES}; do
        sample_dir=${INPUT_DIR}/${sample}
        sample_reads_1_dir=${sample_dir}/reads_1
        sample_reads_2_dir=${sample_dir}/reads_2

        if [[ "${READS_TYPE}" == "single" ]]; then
            bisulfite_se_reads ${sample} ${species} ${BOWTIE2_INDICES}/${species} ${NUM_THREADS} $(listFiles ${sample_reads_1_dir}/*) ${OUTPUT_DIR} ${BISMARK_EXECUTABLE}
        else
            bisulfite_pe_reads ${sample} ${species} ${BOWTIE2_INDICES}/${species} ${NUM_THREADS} $(listFiles ${sample_reads_1_dir}/*) $(listFiles ${sample_reads_2_dir}/*) ${OUTPUT_DIR} ${BISMARK_EXECUTABLE}
        fi
    done
done
wait
