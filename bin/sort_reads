#!/usr/bin/env bash

set -o nounset
set -o errexit
set -o xtrace

SPECIES=$1
SAMPLES=$2
NUM_THREADS=$3
INPUT_DIR=$4
OUTPUT_DIR=$5
TMP_DIR=$6

for species in ${SPECIES}; do
    for sample in ${SAMPLES}; do
        sample_bam=${sample}.${species}.bam
        sambamba sort --tmpdir ${TMP_DIR} -t ${NUM_THREADS} -n -o ${OUTPUT_DIR}/${sample_bam} ${INPUT_DIR}/${sample_bam}

        #bismark generate .ambig.bam file. sort it if exist.
        bismark_ambig_bam=${sample}.${species}.ambig.bam
        if [[ -e "${INPUT_DIR}/${bismark_ambig_bam}" ]]; then
            sambamba sort --tmpdir ${TMP_DIR} -t ${NUM_THREADS} -n -o ${OUTPUT_DIR}/${bismark_ambig_bam} ${INPUT_DIR}/${bismark_ambig_bam}
            ## we merge the sample_bam and the bismark_ambig_bam file
            mv ${OUTPUT_DIR}/${sample_bam} ${OUTPUT_DIR}/${sample_bam%.bam}.premerge.bam
            sambamba merge -l 1 ${OUTPUT_DIR}/${sample_bam} ${OUTPUT_DIR}/${sample_bam%.bam}.premerge.bam ${OUTPUT_DIR}/${bismark_ambig_bam}
        fi

    done
done
